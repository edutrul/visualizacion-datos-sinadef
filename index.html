<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tablero SINADEF – Visualización y comunicación</title>
    <style>
        :root{
            --minsa-navy:#050C3C;
            --minsa-green:#67885E;
            --text:#1A1A1A;
            --muted:#6b7280;
            --grid:#D9D9D9;
            --bg:#ffffff;
            --card:#ffffff;
            --border:#e5e7eb;
            --shadow:0 10px 25px rgba(0,0,0,.06);
            --radius:14px;
        }
        *{box-sizing:border-box}
        body{
            margin:0; background:#f7f8fb; color:var(--text);
            font: 14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
        }
        .wrap{max-width:1120px; margin:22px auto; padding:0 18px;}
        header{ text-align:center; margin-bottom:14px;}
        header h1{margin:0 0 6px; font-size:20px; color:var(--minsa-navy);}
        header p{margin:0; color:var(--muted); font-size:12.5px;}
        .panel{
            background:var(--card); border:1px solid var(--border);
            border-radius:var(--radius); box-shadow:var(--shadow);
            padding:14px; margin:12px 0;
        }
        .controls{
            display:grid;
            grid-template-columns: 1.2fr .9fr .8fr;
            gap:10px; align-items:end;
        }
        .control-box{border:1px dashed var(--border); border-radius:12px; padding:10px;}
        .label{font-size:12px; color:var(--muted); margin:0 0 6px;}
        .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
        input[type="range"]{width:240px;}
        .pill{
            display:inline-flex; align-items:center; gap:6px;
            padding:6px 10px; border-radius:999px;
            background:#eef2ff; color:var(--minsa-navy); font-weight:600; font-size:12px;
        }
        button{
            border:1px solid var(--border); background:white;
            border-radius:10px; padding:9px 12px; cursor:pointer;
            font-weight:600;
        }
        button:hover{border-color:#cbd5e1}
        select{
            border:1px solid var(--border); border-radius:10px;
            padding:9px 10px; background:white; width:100%;
        }

        .kpis{
            display:grid;
            grid-template-columns: repeat(4, 1fr);
            gap:10px;
        }
        .kpi{
            background:var(--card); border:1px solid var(--border);
            border-radius:var(--radius); box-shadow:var(--shadow);
            padding:12px;
        }
        .kpi .t{font-size:12px; color:var(--muted); margin:0 0 6px;}
        .kpi .v{font-size:22px; font-weight:800; color:var(--minsa-navy); margin:0;}
        .kpi .s{font-size:12px; color:var(--muted); margin:4px 0 0;}
        .grid{
            display:grid;
            grid-template-columns: 1.2fr .8fr;
            gap:12px;
        }
        .chart-title{
            display:flex; align-items:baseline; justify-content:space-between; gap:10px;
            margin-bottom:6px;
        }
        .chart-title h3{margin:0; font-size:13px; color:var(--minsa-navy);}
        .note{font-size:12px; color:var(--muted);}
        .insight{
            margin-top:10px; display:flex; gap:10px; align-items:flex-start;
            border-top:1px dashed var(--border); padding-top:10px;
        }
        .badge{
            background:#eef2ff; color:var(--minsa-navy);
            font-weight:800; font-size:11px; border-radius:999px;
            padding:6px 10px; white-space:nowrap;
        }
        .foot{
            margin-top:12px; font-size:11.5px; color:var(--muted);
            text-align:center;
        }
        svg{width:100%; height:auto; display:block;}
        .axis text{fill:#374151; font-size:11px}
        .gridline{stroke:var(--grid); stroke-width:1; opacity:.7}
        .bar{fill:rgba(5,12,60,.25)}
        .bar.highlight{fill:var(--minsa-navy)}
        .hbar{fill:rgba(103,136,94,.28)}
        .hbar.highlight{fill:var(--minsa-green)}
        .tickline{stroke:#9ca3af; stroke-width:1}
        @media (max-width: 980px){
            .kpis{grid-template-columns:1fr 1fr}
            .grid{grid-template-columns:1fr}
            .controls{grid-template-columns:1fr}
            input[type="range"]{width:100%;}
        }
    </style>
</head>
<body>
<div class="wrap">
    <header>
        <h1>¿Cuándo y dónde se concentraron los fallecimientos registrados en el Perú?</h1>
        <p>Tablero de control (SINADEF – Datos Abiertos). Curso: “Visualización y comunicación en Data Science”.</p>
    </header>

    <section class="panel controls">
        <div class="control-box">
            <p class="label"><strong>Rango de años</strong> (afecta todo el tablero)</p>
            <div class="row">
                <span class="pill">Desde: <span id="fromYearLabel">—</span></span>
                <input id="fromYear" type="range" min="0" max="0" value="0" />
                <span class="pill">Hasta: <span id="toYearLabel">—</span></span>
                <input id="toYear" type="range" min="0" max="0" value="0" />
            </div>
            <p class="note" style="margin:8px 0 0;">Tip: mueve primero “Hasta”, luego ajusta “Desde”.</p>
        </div>

        <div class="control-box">
            <p class="label"><strong>Vista rápida</strong></p>
            <select id="quickView">
                <option value="all">Todo (rango completo)</option>
                <option value="pre2020">2017–2019 (pre pandemia)</option>
                <option value="pandemic">2020–2021 (pandemia)</option>
                <option value="post2022">2022–último (post pico)</option>
            </select>
        </div>

        <div class="control-box">
            <p class="label"><strong>Acciones</strong></p>
            <div class="row">
                <button id="resetBtn">Reiniciar filtro</button>
            </div>
            <p class="note" style="margin:8px 0 0;">Fuente: SINADEF – Datos Abiertos (MINSA). Elaboración propia.</p>
        </div>
    </section>

    <section class="kpis">
        <div class="kpi">
            <p class="t">Total de registros (filtrado)</p>
            <p class="v" id="kpiTotal">—</p>
            <p class="s">Suma de registros por año en el rango</p>
        </div>
        <div class="kpi">
            <p class="t">Rango temporal (filtrado)</p>
            <p class="v" id="kpiRange">—</p>
            <p class="s">Años seleccionados</p>
        </div>
        <div class="kpi">
            <p class="t">Año pico (filtrado)</p>
            <p class="v" id="kpiPeakYear">—</p>
            <p class="s"><span id="kpiPeakVal">—</span> registros</p>
        </div>
        <div class="kpi">
            <p class="t">Departamento líder (global)</p>
            <p class="v" id="kpiDeptTop">—</p>
            <p class="s"><span id="kpiDeptTopVal">—</span> registros (Top 1 global)</p>
        </div>
    </section>

    <section class="grid">
        <div class="panel">
            <div class="chart-title">
                <h3>Distribución temporal: fallecimientos registrados por año</h3>
                <span class="note" id="noteYears">—</span>
            </div>
            <div id="chartYear"></div>
            <div class="insight">
                <div class="badge">Insight</div>
                <div class="note" id="insightYear">—</div>
            </div>
        </div>

        <div class="panel">
            <div class="chart-title">
                <h3>Estacionalidad: registros por mes (agregado)</h3>
                <span class="note" id="noteMonths">—</span>
            </div>
            <div id="chartMonth"></div>
            <div class="insight">
                <div class="badge">Nota</div>
                <div class="note">Esta serie utiliza el campo año-mes  <code>(AAAA-MM)</code> y se filtra según el rango de años seleccionado.</div>
            </div>
        </div>
    </section>

    <section class="panel">
        <div class="chart-title">
            <h3>Concentración geográfica: Top 10 departamentos con más registros</h3>
            <span class="note">Ranking global (no cambia por año con el JSON actual)</span>
        </div>
        <div id="chartDept"></div>
        <div class="insight">
            <div class="badge">Hallazgo</div>
            <div class="note" id="insightDept">—</div>
        </div>
    </section>

    <div class="foot" id="footSrc">
        Fuente: SINADEF – Datos Abiertos (MINSA). Fecha de actualización del tablero: <span id="updatedAt">2026-01-28</span>. Elaboración propia.
    </div>
</div>

<script>
    /**
     * Dashboard sin librerías externas (rápido, portable).
     * Evita NaN con:
     * - parseNumberSafe()
     * - guardas si arrays quedan vacíos por filtro
     */

    const UPDATED_AT = "2026-01-28";

    // Ajusta si cambias el nombre del archivo:
    const FILE_YEAR  = "data_year.json";
    const FILE_DEPT  = "data_dept.json";
    const FILE_MONTH = "data_month.json"; // <-- el corregido

    document.getElementById("updatedAt").textContent = UPDATED_AT;

    function parseNumberSafe(x){
        const n = Number(x);
        return Number.isFinite(n) ? n : 0;
    }
    function formatInt(n){
        const v = parseNumberSafe(n);
        return v.toLocaleString("es-PE");
    }
    function clamp(a, min, max){ return Math.max(min, Math.min(max, a)); }

    async function loadJson(path){
        const r = await fetch(path, {cache:"no-store"});
        if (!r.ok) throw new Error("No se pudo cargar: " + path);
        return await r.json();
    }

    let YEAR = [];   // [{year, value}]
    let DEPT = [];   // [{department, value}]
    let MONTH = [];  // [{year_month, value}] year_month = "YYYY-MM"

    let yearsList = []; // [2017,2018,...]
    let range = {from: null, to: null};

    const elFrom = document.getElementById("fromYear");
    const elTo   = document.getElementById("toYear");
    const elFromLabel = document.getElementById("fromYearLabel");
    const elToLabel   = document.getElementById("toYearLabel");

    function setRangeByYears(fromY, toY){
        const minY = yearsList[0];
        const maxY = yearsList[yearsList.length-1];
        fromY = clamp(fromY, minY, maxY);
        toY   = clamp(toY, minY, maxY);
        if (fromY > toY) [fromY, toY] = [toY, fromY];

        range.from = fromY;
        range.to = toY;

        elFrom.value = yearsList.indexOf(fromY);
        elTo.value   = yearsList.indexOf(toY);

        elFromLabel.textContent = fromY;
        elToLabel.textContent   = toY;

        renderAll();
    }

    function initSliders(){
        elFrom.min = 0;
        elFrom.max = yearsList.length - 1;
        elTo.min = 0;
        elTo.max = yearsList.length - 1;

        elFrom.value = 0;
        elTo.value = yearsList.length - 1;

        const syncLabels = () => {
            const fromY = yearsList[parseInt(elFrom.value,10)];
            const toY   = yearsList[parseInt(elTo.value,10)];
            elFromLabel.textContent = fromY ?? "—";
            elToLabel.textContent   = toY ?? "—";
        };

        elFrom.addEventListener("input", () => {
            syncLabels();
        });
        elTo.addEventListener("input", () => {
            syncLabels();
        });

        elFrom.addEventListener("change", () => {
            let fromY = yearsList[parseInt(elFrom.value,10)];
            let toY   = yearsList[parseInt(elTo.value,10)];
            if (fromY > toY) fromY = toY;
            setRangeByYears(fromY, toY);
        });
        elTo.addEventListener("change", () => {
            let fromY = yearsList[parseInt(elFrom.value,10)];
            let toY   = yearsList[parseInt(elTo.value,10)];
            if (fromY > toY) toY = fromY;
            setRangeByYears(fromY, toY);
        });

        syncLabels();
    }

    function getFilteredYearSeries(){
        return YEAR
            .map(d => ({year: parseNumberSafe(d.year), value: parseNumberSafe(d.value)}))
            .filter(d => d.year >= range.from && d.year <= range.to)
            .sort((a,b)=>a.year-b.year);
    }

    function getFilteredMonthSeries(){
        // year_month = "YYYY-MM"
        return MONTH
            .map(d => {
                const ym = String(d.year_month || "");
                const y = parseNumberSafe(ym.slice(0,4));
                const m = parseNumberSafe(ym.slice(5,7));
                return {year: y, month: m, ym, value: parseNumberSafe(d.value)};
            })
            .filter(d => d.year >= range.from && d.year <= range.to)
            .sort((a,b)=> (a.year-b.year) || (a.month-b.month));
    }

    function getTopDeptGlobal(){
        const list = DEPT
            .map(d => ({department: String(d.department||"").toUpperCase().trim(), value: parseNumberSafe(d.value)}))
            .filter(d => d.department && d.value>0)
            .sort((a,b)=>b.value-a.value);
        return list;
    }

    /* ---------- Simple SVG Charts (bar / spark bars / horizontal bars) ---------- */

    function svgEl(tag, attrs={}){
        const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
        for (const [k,v] of Object.entries(attrs)) el.setAttribute(k, v);
        return el;
    }

    function renderBarChart(containerId, data, opts){
        const el = document.getElementById(containerId);
        el.innerHTML = "";

        const width = 680, height = 260;
        const padL = 52, padR = 16, padT = 10, padB = 42;
        const innerW = width - padL - padR;
        const innerH = height - padT - padB;

        const svg = svgEl("svg", {viewBox:`0 0 ${width} ${height}`, role:"img"});
        svg.appendChild(svgEl("rect", {x:0,y:0,width:width,height:height,fill:"white"}));

        if (!data.length){
            const t = svgEl("text",{x:width/2,y:height/2,"text-anchor":"middle",fill:"#6b7280","font-size":"13"});
            t.textContent = "No hay datos en el rango seleccionado.";
            svg.appendChild(t);
            el.appendChild(svg);
            return;
        }

        const maxV = Math.max(...data.map(d=>d.value), 1);

        // gridlines (y)
        const lines = 4;
        for (let i=0;i<=lines;i++){
            const y = padT + (innerH * i/lines);
            svg.appendChild(svgEl("line",{x1:padL,y1:y,x2:padL+innerW,y2:y,class:"gridline"}));
            const val = Math.round(maxV * (1 - i/lines));
            const txt = svgEl("text",{x:padL-8,y:y+4,"text-anchor":"end",class:"axis"});
            txt.textContent = val.toLocaleString("es-PE");
            svg.appendChild(txt);
        }

        const n = data.length;
        const gap = Math.max(4, innerW * 0.02 / n);
        const barW = (innerW - gap*(n-1)) / n;

        const peak = data.reduce((a,b)=> (b.value>a.value?b:a), data[0]);

        data.forEach((d, i)=>{
            const x = padL + i*(barW+gap);
            const h = (d.value/maxV) * innerH;
            const y = padT + (innerH - h);

            const rect = svgEl("rect",{
                x, y, width:barW, height:h,
                rx:4, ry:4,
                class: (d.year===peak.year ? "bar highlight" : "bar")
            });
            svg.appendChild(rect);

            // x labels: show every 2-3 if too many
            const showEvery = n > 12 ? 2 : 1;
            if (i % showEvery === 0){
                const tx = svgEl("text",{x:x+barW/2,y:height-18,"text-anchor":"middle",class:"axis"});
                tx.textContent = String(d.year);
                svg.appendChild(tx);
            }
        });

        // axis baseline
        svg.appendChild(svgEl("line",{x1:padL,y1:padT+innerH,x2:padL+innerW,y2:padT+innerH,class:"tickline"}));

        el.appendChild(svg);
    }

    function renderMonthlyMiniBars(containerId, data){
        const el = document.getElementById(containerId);
        el.innerHTML = "";

        const width = 680, height = 260;
        const padL = 52, padR = 16, padT = 10, padB = 42;
        const innerW = width - padL - padR;
        const innerH = height - padT - padB;

        const svg = svgEl("svg", {viewBox:`0 0 ${width} ${height}`, role:"img"});
        svg.appendChild(svgEl("rect", {x:0,y:0,width:width,height:height,fill:"white"}));

        if (!data.length){
            const t = svgEl("text",{x:width/2,y:height/2,"text-anchor":"middle",fill:"#6b7280","font-size":"13"});
            t.textContent = "No hay datos mensuales en el rango seleccionado.";
            svg.appendChild(t);
            el.appendChild(svg);
            return;
        }

        const maxV = Math.max(...data.map(d=>d.value), 1);

        // gridlines (y)
        const lines = 4;
        for (let i=0;i<=lines;i++){
            const y = padT + (innerH * i/lines);
            svg.appendChild(svgEl("line",{x1:padL,y1:y,x2:padL+innerW,y2:y,class:"gridline"}));
        }

        const n = data.length;
        const gap = 1;
        const barW = (innerW - gap*(n-1)) / n;

        data.forEach((d, i)=>{
            const x = padL + i*(barW+gap);
            const h = (d.value/maxV) * innerH;
            const y = padT + (innerH - h);
            const rect = svgEl("rect",{
                x, y, width:barW, height:h,
                rx:2, ry:2,
                fill:"rgba(103,136,94,.28)"
            });
            svg.appendChild(rect);

            // etiqueta cada enero (mes 1)
            if (d.month === 1){
                const tx = svgEl("text",{x:x+2,y:height-18,"text-anchor":"start",class:"axis"});
                tx.textContent = String(d.year);
                svg.appendChild(tx);
            }
        });

        svg.appendChild(svgEl("line",{x1:padL,y1:padT+innerH,x2:padL+innerW,y2:padT+innerH,class:"tickline"}));
        el.appendChild(svg);
    }

    function renderHorizontalBars(containerId, data){
        const el = document.getElementById(containerId);
        el.innerHTML = "";

        const width = 900, height = 320;
        const padL = 110, padR = 16, padT = 14, padB = 26;
        const innerW = width - padL - padR;
        const innerH = height - padT - padB;

        const svg = svgEl("svg", {viewBox:`0 0 ${width} ${height}`, role:"img"});
        svg.appendChild(svgEl("rect", {x:0,y:0,width:width,height:height,fill:"white"}));

        if (!data.length){
            const t = svgEl("text",{x:width/2,y:height/2,"text-anchor":"middle",fill:"#6b7280","font-size":"13"});
            t.textContent = "No hay datos de departamentos.";
            svg.appendChild(t);
            el.appendChild(svg);
            return;
        }

        const maxV = Math.max(...data.map(d=>d.value), 1);
        const n = data.length;
        const rowH = innerH / n;

        // gridlines x
        const lines = 4;
        for (let i=0;i<=lines;i++){
            const x = padL + (innerW * i/lines);
            svg.appendChild(svgEl("line",{x1:x,y1:padT,x2:x,y2:padT+innerH,class:"gridline"}));
            const val = Math.round(maxV * (i/lines));
            const txt = svgEl("text",{x:x,y:height-8,"text-anchor":"middle",class:"axis"});
            txt.textContent = val.toLocaleString("es-PE");
            svg.appendChild(txt);
        }

        data.forEach((d, i)=>{
            const y = padT + i*rowH + rowH*0.18;
            const h = rowH*0.64;
            const w = (d.value/maxV) * innerW;

            const isTop = (i===0);
            const rect = svgEl("rect",{
                x:padL, y, width:w, height:h,
                rx:6, ry:6,
                class: isTop ? "hbar highlight" : "hbar"
            });
            svg.appendChild(rect);

            const label = svgEl("text",{x:padL-10,y:y+h*0.72,"text-anchor":"end",class:"axis"});
            label.textContent = d.department;
            svg.appendChild(label);
        });

        // axis baseline
        svg.appendChild(svgEl("line",{x1:padL,y1:padT+innerH,x2:padL+innerW,y2:padT+innerH,class:"tickline"}));
        el.appendChild(svg);
    }

    /* ---------- Render everything ---------- */

    function renderAll(){
        // Year filtered
        const ySeries = getFilteredYearSeries();

        // KPIs from filtered year series
        const total = ySeries.reduce((acc,d)=>acc + d.value, 0);

        let peakYear = "—", peakVal = 0;
        if (ySeries.length){
            const peak = ySeries.reduce((a,b)=> (b.value>a.value?b:a), ySeries[0]);
            peakYear = String(peak.year);
            peakVal = peak.value;
        }

        document.getElementById("kpiTotal").textContent = formatInt(total);
        document.getElementById("kpiRange").textContent = `${range.from}–${range.to}`;
        document.getElementById("kpiPeakYear").textContent = peakYear;
        document.getElementById("kpiPeakVal").textContent = formatInt(peakVal);

        document.getElementById("noteYears").textContent = `Rango activo: ${range.from}–${range.to}`;
        document.getElementById("insightYear").textContent =
            ySeries.length
                ? `Dentro del rango seleccionado, el mayor número de registros ocurre en ${peakYear} (${formatInt(peakVal)}).`
                : `Ajusta el rango para ver el pico anual.`;

        // Charts
        renderBarChart("chartYear", ySeries);

        // Month filtered
        const mSeries = getFilteredMonthSeries();
        document.getElementById("noteMonths").textContent =
            mSeries.length ? `${mSeries.length} meses en el rango` : "—";
        renderMonthlyMiniBars("chartMonth", mSeries);

        // Dept global (top 10)
        const deptList = getTopDeptGlobal().slice(0,10);
        renderHorizontalBars("chartDept", deptList);

        if (deptList.length){
            document.getElementById("kpiDeptTop").textContent = deptList[0].department;
            document.getElementById("kpiDeptTopVal").textContent = formatInt(deptList[0].value);
            document.getElementById("insightDept").textContent =
                `La mayor concentración global se observa en ${deptList[0].department}. Esto sugiere un foco urbano/poblacional importante (no implica causalidad, solo concentración de registros).`;
        } else {
            document.getElementById("kpiDeptTop").textContent = "—";
            document.getElementById("kpiDeptTopVal").textContent = "—";
            document.getElementById("insightDept").textContent = "No hay datos de departamentos disponibles.";
        }
    }

    /* ---------- Quick view + reset ---------- */

    document.getElementById("quickView").addEventListener("change", (e)=>{
        const v = e.target.value;
        const minY = yearsList[0];
        const maxY = yearsList[yearsList.length-1];

        if (v === "all") setRangeByYears(minY, maxY);
        if (v === "pre2020") setRangeByYears(2017, 2019);
        if (v === "pandemic") setRangeByYears(2020, 2021);
        if (v === "post2022") setRangeByYears(2022, maxY);
    });

    document.getElementById("resetBtn").addEventListener("click", ()=>{
        const minY = yearsList[0];
        const maxY = yearsList[yearsList.length-1];
        document.getElementById("quickView").value = "all";
        setRangeByYears(minY, maxY);
    });

    /* ---------- Boot ---------- */
    (async function boot(){
        try{
            const [year, dept, month] = await Promise.all([
                loadJson(FILE_YEAR),
                loadJson(FILE_DEPT),
                loadJson(FILE_MONTH),
            ]);

            YEAR = Array.isArray(year) ? year : [];
            DEPT = Array.isArray(dept) ? dept : [];
            MONTH = Array.isArray(month) ? month : [];

            yearsList = YEAR
                .map(d => parseNumberSafe(d.year))
                .filter(y => y > 0)
                .sort((a,b)=>a-b);

            if (!yearsList.length){
                alert("data_year.json no tiene años válidos. Revisa el archivo.");
                return;
            }

            initSliders();
            setRangeByYears(yearsList[0], yearsList[yearsList.length-1]);

        } catch(err){
            console.error(err);
            alert("Error cargando archivos JSON. Abre consola para ver detalle.\n" + err.message);
        }
    })();
</script>
</body>
</html>